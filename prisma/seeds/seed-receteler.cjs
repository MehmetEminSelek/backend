// ===================================================================
// üßæ RE√áETELER SEED SCRIPT
// CSV'den re√ßete ve re√ßete i√ßeriklerini kaydetme
// ===================================================================

const fs = require('fs');
const csv = require('csv-parser');
const path = require('path');
const { PrismaClient } = require('@prisma/client');

const prisma = new PrismaClient();

// CSV dosya yolu
const CSV_PATH = path.join(__dirname, '../../veriler/Re√ßeteler.csv');

/**
 * CSV dosyasƒ±nƒ± okuyan Promise-based helper
 */
function readCSV(filePath, encoding = 'utf8') {
    return new Promise((resolve, reject) => {
        const results = [];

        if (!fs.existsSync(filePath)) {
            reject(new Error(`CSV dosyasƒ± bulunamadƒ±: ${filePath}`));
            return;
        }

        fs.createReadStream(filePath, { encoding })
            .pipe(csv())
            .on('data', (data) => results.push(data))
            .on('end', () => resolve(results))
            .on('error', reject);
    });
}

/**
 * Stok adƒ±nƒ± Material koduna e≈üle≈ütirir
 */
function mapStokToMaterialKod(stokAdi) {
    const materialMap = {
        // Hammaddeler
        'SADE YAG': 'HM012',  // SADEYAƒû
        'ANTEP PEYNIRI': 'HM001',
        'MAYDANOZ': 'HM010',
        'FISTIK': 'HM006',    // ƒ∞√á FISTIK
        'TOZ SEKER': 'HM017',
        'SU': 'HM014',
        'GLIKOZ': 'HM003',
        'IRMIK NO:0': 'HM004',
        'IRMIK NO:3': 'HM005',
        'YOGURT': 'HM019',    // YOƒûURT
        'SODA GR': 'HM013',
        'KARAKOYUNLU UN': 'HM008',
        'KADAYIF': 'HM007',
        'CEVIZ': 'HM002',
        'TEKSIN UN': 'HM016',
        'YUMURTA': 'HM020',
        'TUZ': 'HM018',
        'NISASTA': 'HM011',   // NI≈ûASTA
        'LIMON': 'HM009',
        'SUT': 'HM015',       // S√úT

        // Yarƒ± Mamuller
        'HAMUR (YM)': 'YM001',
        'SERBET (YM)': 'YM003',
        'KAYMAK (YM)': 'YM002'
    };

    return materialMap[stokAdi] || null;
}

/**
 * Birim standardizasyonu (hepsini standard birimlere √ßevir)
 */
function standardizeBirim(birim, miktar) {
    const birimMap = {
        'kg': { standardBirim: 'KG', carpan: 1 },
        'gr': { standardBirim: 'KG', carpan: 0.001 },  // gram -> kg
        'lt': { standardBirim: 'LITRE', carpan: 1 },
        'ml': { standardBirim: 'LITRE', carpan: 0.001 }, // ml -> lt
        'Adet': { standardBirim: 'ADET', carpan: 1 }
    };

    const mapping = birimMap[birim] || { standardBirim: 'KG', carpan: 1 };

    return {
        standardBirim: mapping.standardBirim,
        standardMiktar: miktar * mapping.carpan
    };
}

/**
 * Fire oranƒ±nƒ± parse eder (6.00% -> 0.06)
 */
function parseFireOrani(fireStr) {
    if (!fireStr || fireStr === '0.00%') return 0;
    return parseFloat(fireStr.replace('%', '')) / 100;
}

/**
 * CSV'den re√ßeteleri parse eder
 */
function parseReceteler(csvData) {
    const receteler = [];
    let currentRecipe = null;
    let currentIngredients = [];

    console.log('üîç Re√ßeteler parse ediliyor...\n');

    csvData.forEach((row, index) => {
        const firstCol = Object.values(row)[0]; // ƒ∞lk kolonun deƒüeri

        // Yeni re√ßete ba≈ülangƒ±cƒ± kontrol√º (√ºr√ºn adƒ± i√ßeren satƒ±rlar)
        if (firstCol && firstCol.includes('(UR)') || firstCol.includes('(YM)')) {
            // √ñnceki re√ßeteyi kaydet
            if (currentRecipe) {
                currentRecipe.ingredients = [...currentIngredients];
                receteler.push(currentRecipe);
            }

            // Yeni re√ßete ba≈ülat
            const recipeAdi = firstCol.trim();
            const recipeKodu = generateRecipeKod(recipeAdi);

            currentRecipe = {
                ad: recipeAdi,
                kod: recipeKodu,
                tip: firstCol.includes('(UR)') ? 'URUN' : 'YARI_MAMUL',
                aktif: true,
                aciklama: `${recipeAdi} re√ßetesi`
            };

            currentIngredients = [];
            console.log(`üìù ${recipeAdi} re√ßetesi ba≈üladƒ± (${recipeKodu})`);

        } else if (row['Stok Adƒ±'] && row['Stok Adƒ±'] !== 'Stok Adƒ±' && row['Stok Adƒ±'].trim()) {
            // Malzeme satƒ±rƒ±
            const stokAdi = row['Stok Adƒ±'].trim();
            const birim = row['Birim'];
            const netMiktar = parseFloat(row['Net Miktar']) || 0;
            const fire1 = parseFireOrani(row['Fire1']);
            const fire2 = parseFireOrani(row['Fire2']);
            const gerMiktar = parseFloat(row['Ger Mktr']) || netMiktar;

            if (netMiktar > 0) {
                const materialKod = mapStokToMaterialKod(stokAdi);

                if (materialKod) {
                    const birimInfo = standardizeBirim(birim, netMiktar);
                    const gerMiktarInfo = standardizeBirim(birim, gerMiktar);

                    const ingredient = {
                        stokAdi: stokAdi,
                        materialKod: materialKod,
                        miktar: birimInfo.standardMiktar,
                        birim: birimInfo.standardBirim,
                        fire1: fire1,
                        fire2: fire2,
                        gerMiktar: gerMiktarInfo.standardMiktar,
                        originalBirim: birim,
                        originalMiktar: netMiktar
                    };

                    currentIngredients.push(ingredient);
                    console.log(`   ‚úÖ ${stokAdi} -> ${materialKod} (${birimInfo.standardMiktar} ${birimInfo.standardBirim})`);
                } else {
                    console.log(`   ‚ö†Ô∏è  ${stokAdi} i√ßin material mapping bulunamadƒ±`);
                }
            }
        }
    });

    // Son re√ßeteyi kaydet
    if (currentRecipe) {
        currentRecipe.ingredients = [...currentIngredients];
        receteler.push(currentRecipe);
    }

    return receteler;
}

/**
 * Re√ßete kodu olu≈üturur
 */
function generateRecipeKod(recipeAdi) {
    // Basit kod olu≈üturma
    const kodMap = {
        'PEYNIRLI SU BOREGI (UR)': 'RCP001',
        'EZME (UR)': 'RCP002',
        'FISTIKLI KURABƒ∞YE': 'RCP003',
        'SADE KURABIYE': 'RCP004',
        'DOLAMA (UR)': 'RCP005',
        'BURMA KADAYIF (UR)': 'RCP006',
        'MIDYE (UR)': 'RCP007',
        'HAVUC DILIMI (UR)': 'RCP008',
        'SOBIYET (UR)': 'RCP009',
        'BULBUL YUVASI (UR)': 'RCP010',
        'OZEL KARE BAKLAVA (UR)': 'RCP011',
        'FISTIKLI KURU BAKLAVA (UR)': 'RCP012',
        'FISTIKLI YAS BAKLAVA (UR)': 'RCP013',
        'CEVIZLI BAKLAVA (UR)': 'RCP014',
        'HAMUR (YM)': 'YM_RCP001',
        'SERBET (YM)': 'YM_RCP002',
        'KAYMAK (YM)': 'YM_RCP003'
    };

    return kodMap[recipeAdi] || `RCP${String(Date.now()).substr(-3)}`;
}

/**
 * Maliyet hesaplama helper'ƒ±
 */
async function calculateRecipeCost(recipe) {
    let toplamMaliyet = 0;

    for (const ingredient of recipe.ingredients) {
        try {
            // Material'ƒ± bul
            const material = await prisma.material.findUnique({
                where: { kod: ingredient.materialKod }
            });

            if (material && material.birimFiyat > 0) {
                const malzemeMaliyeti = ingredient.gerMiktar * material.birimFiyat;
                toplamMaliyet += malzemeMaliyeti;
                ingredient.sonFiyat = material.birimFiyat;
                ingredient.maliyet = malzemeMaliyeti;
            }
        } catch (error) {
            console.warn(`Material ${ingredient.materialKod} maliyeti hesaplanamadƒ±:`, error.message);
        }
    }

    return toplamMaliyet;
}

/**
 * Ana seed fonksiyonu
 */
async function main() {
    console.log('üßæ Re√ßeteler seed i≈ülemi ba≈ülƒ±yor...\n');

    try {
        // 1. CSV dosyasƒ±nƒ± oku
        console.log('üìñ CSV dosyasƒ± okunuyor...');
        const csvData = await readCSV(CSV_PATH);

        // 2. Re√ßeteleri parse et
        const receteler = parseReceteler(csvData);

        console.log(`\n‚úÖ ${receteler.length} re√ßete parse edildi`);

        // Kategorilere ayƒ±r
        const urunReceteler = receteler.filter(r => r.tip === 'URUN');
        const yariMamulReceteler = receteler.filter(r => r.tip === 'YARI_MAMUL');

        console.log(`   üìã ${urunReceteler.length} √ºr√ºn re√ßetesi`);
        console.log(`   üîß ${yariMamulReceteler.length} yarƒ± mamul re√ßetesi\n`);

        // 3. Re√ßeteleri ve i√ßeriklerini kaydet
        console.log('üíæ Re√ßeteler kaydediliyor...');

        for (const recipe of receteler) {
            try {
                // Mevcut re√ßeteyi kontrol et
                const existingRecipe = await prisma.recipe.findUnique({
                    where: { kod: recipe.kod }
                });

                let savedRecipe;

                if (!existingRecipe) {
                    // Yeni re√ßete olu≈ütur
                    savedRecipe = await prisma.recipe.create({
                        data: {
                            ad: recipe.ad,
                            kod: recipe.kod,
                            aciklama: recipe.aciklama,
                            aktif: recipe.aktif,
                            test: false,
                            versiyon: '1.0'
                        }
                    });

                    console.log(`   ‚úÖ ${recipe.ad} (${recipe.kod}) olu≈üturuldu`);
                } else {
                    savedRecipe = existingRecipe;
                    console.log(`   ‚ÑπÔ∏è  ${recipe.ad} (${recipe.kod}) zaten mevcut`);
                }

                // 4. Re√ßete i√ßeriklerini kaydet
                for (const ingredient of recipe.ingredients) {
                    try {
                        // Material'ƒ± bul
                        const material = await prisma.material.findUnique({
                            where: { kod: ingredient.materialKod }
                        });

                        if (material) {
                            // Mevcut i√ßerik var mƒ± kontrol et
                            const existingIngredient = await prisma.recipeIngredient.findUnique({
                                where: {
                                    recipeId_materialId: {
                                        recipeId: savedRecipe.id,
                                        materialId: material.id
                                    }
                                }
                            });

                            if (!existingIngredient) {
                                await prisma.recipeIngredient.create({
                                    data: {
                                        recipeId: savedRecipe.id,
                                        materialId: material.id,
                                        miktar: ingredient.miktar,
                                        birim: ingredient.birim,
                                        fire1: ingredient.fire1,
                                        fire2: ingredient.fire2,
                                        gerMiktar: ingredient.gerMiktar,
                                        sonFiyat: material.birimFiyat || 0,
                                        maliyet: (ingredient.gerMiktar * (material.birimFiyat || 0)),
                                        zorunlu: true
                                    }
                                });

                                console.log(`      ‚úÖ ${ingredient.stokAdi} eklendi`);
                            }
                        } else {
                            console.warn(`      ‚ö†Ô∏è  Material bulunamadƒ±: ${ingredient.materialKod}`);
                        }
                    } catch (error) {
                        console.error(`      ‚ùå ${ingredient.stokAdi} eklenirken hata:`, error.message);
                    }
                }

                // 5. Toplam maliyeti hesapla ve g√ºncelle
                const toplamMaliyet = await calculateRecipeCost(recipe);

                await prisma.recipe.update({
                    where: { id: savedRecipe.id },
                    data: {
                        toplamMaliyet: toplamMaliyet,
                        birimMaliyet: toplamMaliyet, // 1 kg i√ßin maliyet
                        guncellemeTarihi: new Date()
                    }
                });

                console.log(`      üí∞ Toplam maliyet: ${toplamMaliyet.toFixed(2)} TL\n`);

            } catch (error) {
                console.error(`‚ùå ${recipe.ad} kaydedilirken hata:`, error.message);
            }
        }

        // 6. Final √∂zet
        console.log('üéâ RE√áETELER SEED ƒ∞≈ûLEMƒ∞ TAMAMLANDI!');
        console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        console.log(`‚úÖ ${receteler.length} re√ßete i≈ülendi`);
        console.log(`üìã ${urunReceteler.length} √ºr√ºn re√ßetesi`);
        console.log(`üîß ${yariMamulReceteler.length} yarƒ± mamul re√ßetesi`);
        console.log(`üí∞ Maliyet hesaplamalarƒ± tamamlandƒ±`);

    } catch (error) {
        console.error('‚ùå Hata:', error);
        process.exit(1);
    }
}

// Export function
module.exports = { seedReceteler: main }; 